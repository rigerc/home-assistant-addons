# ==============================================================================
# Ingress server configuration for Profilarr
# Listens on ingress_port and proxies to backend application on port 6868
# Variables (%%port%%, %%interface%%) are replaced by cont-init.d script
# ==============================================================================

server {
    listen %%interface%%:%%port%% default_server;
    include /etc/nginx/includes/server_params.conf;
    include /etc/nginx/includes/proxy_params.conf;

    # Allow large file uploads for profile imports
    client_max_body_size 0;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer" always;

    # Main application proxy
    location / {
        # Proxy to backend application
        proxy_pass http://127.0.0.1:6868;

        # Disable buffering for real-time updates
        proxy_buffering off;

        # Pass request headers
        proxy_pass_request_headers on;

        # WebSocket support for real-time updates
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Long timeouts for Profilarr operations (profile sync, git operations)
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
