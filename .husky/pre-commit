#!/usr/bin/env sh
# Prevent commits to domain-specific paths when on main branch
# Portable version that works on Windows, macOS, and Linux

# Get current branch name
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
DOMAIN_PATHS_FILE=".github/domain-paths.yaml"
SCRIPT_DIR="$(dirname "$0")"
PYTHON_SCRIPT="$SCRIPT_DIR/check-domain-paths.py"

# Only check if we're on main branch
if [ "$CURRENT_BRANCH" = "main" ]; then
    # Check if Python script exists
    if [ ! -f "$PYTHON_SCRIPT" ]; then
        exit 0
    fi

    # Check if domain paths file exists
    if [ ! -f "$DOMAIN_PATHS_FILE" ]; then
        exit 0
    fi

    # Get all staged files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

    if [ -z "$STAGED_FILES" ]; then
        exit 0
    fi

    # Use Python for cross-platform YAML parsing and pattern matching
    # Try python3 first, then fall back to python (Windows)
    if command -v python3 >/dev/null 2>&1; then
        PYTHON_CMD=python3
    elif command -v python >/dev/null 2>&1; then
        PYTHON_CMD=python
    elif command -v py >/dev/null 2>&1; then
        # Windows Python launcher
        PYTHON_CMD=py
    else
        # No Python available, skip the check
        exit 0
    fi

    # Run the Python script with the domain file and staged files
    $PYTHON_CMD "$PYTHON_SCRIPT" "$DOMAIN_PATHS_FILE" $STAGED_FILES
    exit $?
fi

exit 0
