#!/bin/sh

# Pre-commit hook to prevent direct commits to domain paths on main branch
# Reads domain path ownership from .github/domain-paths.yaml

set -e

DOMAIN_PATHS_FILE=".github/domain-paths.yaml"

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Only check on main branch
if [ "$BRANCH" = "main" ]; then
    # Check if yq is available
    if ! command -v yq >/dev/null 2>&1; then
        echo "⚠️  Warning: 'yq' is not installed. Skipping domain path check."
        echo "   Install yq to enable this pre-commit hook: https://github.com/mikefarah/yq"
        exit 0
    fi

    # Check if domain-paths.yaml exists
    if [ ! -f "$DOMAIN_PATHS_FILE" ]; then
        echo "⚠️  Warning: '$DOMAIN_PATHS_FILE' not found. Skipping domain path check."
        exit 0
    fi

    # Extract paths from YAML using yq
    PROTECTED_PATHS=$(yq eval '.domains.*.paths[]' "$DOMAIN_PATHS_FILE" 2>/dev/null)

    if [ -z "$PROTECTED_PATHS" ]; then
        exit 0
    fi

    # Get list of staged files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

    if [ -n "$STAGED_FILES" ]; then
        for file in $STAGED_FILES; do
            # Check if file matches any protected path pattern
            for pattern in $PROTECTED_PATHS; do
                # Convert glob pattern to regex (huntarr/** -> ^huntarr/)
                prefix=$(echo "$pattern" | sed 's/\/\*\*$//')
                case "$file" in
                    ${prefix}*)
                        echo ""
                        echo "❌ Commit blocked: Direct commits to '$prefix' are not allowed on 'main' branch."
                        echo ""
                        echo "Please create a feature branch for changes to this domain."
                        echo ""
                        exit 1
                        ;;
                esac
            done
        done
    fi
fi

exit 0
