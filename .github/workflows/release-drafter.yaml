---
name: Release Drafter

# yamllint disable-line rule:truthy
on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [main]
  workflow_run:
    workflows: [addon-metadata]
    types: [completed]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  find:
    name: Find add-ons
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'ci')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      addons: ${{ steps.build_list.outputs.addons }}
    steps:
      - name: â¤µï¸ Check out code from GitHub
        uses: actions/checkout@v4
      - name: ğŸ” Find all add-ons
        id: addons
        uses: ./.github/actions/find-addons
      - name: ğŸ—ï¸ Filter changed add-ons
        id: changed_addons
        uses: dorny/paths-filter@v3
        with:
          filters: ${{ steps.addons.outputs.addons_json == '[]' && '{}' || format('{{ {0} }}', steps.addons.outputs.addons_json) }}
          list-files: skip
      - name: ğŸ¦º Build changed add-ons list
        id: build_list
        run: |
          # Output the changes directly as the addons list
          addons="${{ steps.changed_addons.outputs.changes }}"
          if [[ -z "$addons" ]]; then
            addons="[]"
          fi
          echo "addons=$addons" >> "$GITHUB_OUTPUT"
          echo "Changed add-ons: $addons"

  update_release_draft:
    permissions:
      contents: write
      pull-requests: read
    name: âœï¸ Draft release
    runs-on: ubuntu-latest
    needs: find
    if: needs.find.outputs.addons != '[]'
    strategy:
      matrix:
        path: ${{ fromJson(needs.find.outputs.addons) }}
    steps:
      - name: ğŸš€ Run Release Drafter for ${{ matrix.path }}
        uses: release-drafter/release-drafter@v6
        with:
          config-name: "release-drafter-${{ matrix.path }}.yml"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
