---
name: Manual Deploy

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to deploy'
        required: true
        type: choice
        options:
          - huntarr
          - profilarr
          - romm
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (no push/publish)'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-${{ inputs.domain }}
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    name: üì¶ Bump ${{ inputs.domain }} version
    outputs:
      new_version: ${{ steps.bump.outputs.version }}
      old_version: ${{ steps.current.outputs.version }}
    steps:
      - name: ‚§µÔ∏è Check out repository
        uses: actions/checkout@v4
        with:
          ref: domain/${{ inputs.domain }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: üîç Get current version
        id: current
        run: |
          CURRENT=$(yq eval '.version' ${{ inputs.domain }}/config.yaml)
          echo "version=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "Current version: $CURRENT"

      - name: ‚¨ÜÔ∏è Bump version
        id: bump
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          BUMP_TYPE="${{ inputs.version_bump }}"

          # Parse semantic version (assuming X.Y.Z format)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          # Bump based on type
          case "$BUMP_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "‚úÖ New version: $NEW_VERSION (was $CURRENT)"

          # Update config.yaml
          yq eval -i ".version = \"$NEW_VERSION\"" ${{ inputs.domain }}/config.yaml

          # Show the change
          echo "Updated config.yaml:"
          git diff ${{ inputs.domain }}/config.yaml

      - name: üíæ Commit version bump
        if: inputs.dry_run == false
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add ${{ inputs.domain }}/config.yaml
          git commit -m "chore(${{ inputs.domain }}): bump version to v${{ steps.bump.outputs.version }}"

          git push origin domain/${{ inputs.domain }}

          echo "‚úÖ Version bump committed and pushed"

      - name: üè∑Ô∏è Dry run summary
        if: inputs.dry_run == true
        run: |
          echo "üîç DRY RUN MODE - No changes pushed"
          echo "Would bump from ${{ steps.current.outputs.version }} to ${{ steps.bump.outputs.version }}"

  build-and-push:
    needs: version-bump
    name: üèóÔ∏è Build and push images
    uses: ./.github/workflows/builder.yaml
    with:
      validation_mode: false
      push_images: ${{ inputs.dry_run == false }}
    secrets: inherit

  publish-release:
    needs: [version-bump, build-and-push]
    runs-on: ubuntu-latest
    name: üöÄ Publish release
    steps:
      - name: ‚§µÔ∏è Check out repository
        uses: actions/checkout@v4
        with:
          ref: domain/${{ inputs.domain }}
          fetch-depth: 0

      - name: üì¶ Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: üöÄ Publish release
        if: inputs.dry_run == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DOMAIN="${{ inputs.domain }}"
          VERSION="${{ needs.version-bump.outputs.new_version }}"
          TAG="$DOMAIN-v$VERSION"

          echo "Publishing release: $TAG"

          # Check if draft release exists
          if gh release view "$TAG" &>/dev/null; then
            echo "Found existing draft release, publishing..."

            # Publish the draft release
            gh release edit "$TAG" --draft=false

            echo "‚úÖ Published release: $TAG"
          else
            echo "‚ö†Ô∏è No draft release found for $TAG"
            echo "Creating new release..."

            # Get recent commits
            COMMITS=$(git log -10 --pretty=format:"- %s (%h)" -- "$DOMAIN/")

            # Create release notes
            cat > /tmp/release-notes.md <<EOF
            ## Release for \`$DOMAIN\` v$VERSION

            ### Changes
            $COMMITS

            ### Deployment Information
            - **Version Bump**: ${{ inputs.version_bump }}
            - **Previous Version**: ${{ needs.version-bump.outputs.old_version }}
            - **Deployed**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - **Deployed By**: @${{ github.actor }}

            ---
            üöÄ Deployed via manual workflow
            EOF

            # Create and publish release
            gh release create "$TAG" \
              --title "$DOMAIN v$VERSION" \
              --notes-file /tmp/release-notes.md \
              --target "domain/$DOMAIN"

            echo "‚úÖ Created and published release: $TAG"
          fi

      - name: üè∑Ô∏è Create and push git tag
        if: inputs.dry_run == false
        run: |
          DOMAIN="${{ inputs.domain }}"
          VERSION="${{ needs.version-bump.outputs.new_version }}"
          TAG="$DOMAIN-v$VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag
          git tag -a "$TAG" -m "Release $DOMAIN v$VERSION"

          # Push tag
          git push origin "$TAG"

          echo "‚úÖ Created and pushed tag: $TAG"

      - name: üìù Update PR with deployment info
        if: inputs.dry_run == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DOMAIN="${{ inputs.domain }}"
          VERSION="${{ needs.version-bump.outputs.new_version }}"

          # Find PR for this domain branch
          PR_NUMBER=$(gh pr list --head "domain/$DOMAIN" --json number --jq '.[0].number')

          if [[ -n "$PR_NUMBER" ]]; then
            echo "Found PR #$PR_NUMBER for domain/$DOMAIN"

            # Add comment to PR
            gh pr comment "$PR_NUMBER" --body "üöÄ **Deployed v$VERSION**

            This domain has been deployed:
            - Version: \`$VERSION\`
            - Release: [\`$DOMAIN-v$VERSION\`](https://github.com/${{ github.repository }}/releases/tag/$DOMAIN-v$VERSION)
            - Deployed by: @${{ github.actor }}
            - Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

            The release has been published and images pushed to the registry."

            echo "‚úÖ Added deployment comment to PR #$PR_NUMBER"
          else
            echo "‚ö†Ô∏è No open PR found for domain/$DOMAIN"
          fi

      - name: üè∑Ô∏è Dry run summary
        if: inputs.dry_run == true
        run: |
          echo "üîç DRY RUN MODE - No release published"
          echo "Would publish release: ${{ inputs.domain }}-v${{ needs.version-bump.outputs.new_version }}"
          echo "Would create tag: ${{ inputs.domain }}-v${{ needs.version-bump.outputs.new_version }}"
