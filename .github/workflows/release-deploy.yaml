---
name: Release Deploy

# Triggered by:
# 1. workflow_call from release-please workflow (automatic)
# 2. Manual workflow_dispatch for retries

on:
  workflow_call:
    inputs:
      addon:
        description: 'Add-on name (e.g., profilarr, romm)'
        required: true
        type: string
      version:
        description: 'Version (e.g., 1.2.3)'
        required: true
        type: string
      tag:
        description: 'Release tag (e.g., profilarr-1.2.3)'
        required: true
        type: string

  workflow_dispatch:
    inputs:
      addon:
        description: 'Add-on name (e.g., profilarr, romm)'
        required: true
        type: string
      version:
        description: 'Version (e.g., 1.2.3)'
        required: true
        type: string
      tag:
        description: 'Release tag (e.g., profilarr-1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ inputs.addon }}-${{ inputs.tag }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    name: "Build ${{ inputs.addon }} (${{ matrix.arch }})"
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        arch: [aarch64, amd64]
    steps:
      - name: â¤µï¸ Check out repository
        uses: actions/checkout@v4

      - name: â„¹ï¸ Get addon info
        id: info
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ inputs.addon }}"

      - name: ðŸ¦º Check if add-on should be built
        id: check
        run: |
          # Parse architectures JSON array and check if matrix.arch is included
          architectures='${{ steps.info.outputs.architectures }}'
          if echo "$architectures" | jq -e --arg arch "${{ matrix.arch }}" 'index($arch) != null' > /dev/null; then
             echo "${{ matrix.arch }} is a supported arch for ${{ inputs.addon }}, starting build"
             echo "build_arch=true" >> "$GITHUB_OUTPUT"
             # Strip quotes from image output if present
             image=$(echo '${{ steps.info.outputs.image }}' | jq -r '.')
             echo "image=$image" >> "$GITHUB_OUTPUT"
           else
             echo "${{ matrix.arch }} is not a valid arch for ${{ inputs.addon }}, skipping build"
             echo "build_arch=false" >> "$GITHUB_OUTPUT"
          fi

      - name: ðŸ³ Login to GitHub Container Registry
        if: steps.check.outputs.build_arch == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Build ${{ inputs.addon }} add-on
        if: steps.check.outputs.build_arch == 'true'
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --${{ matrix.arch }} \
            --target /data/${{ inputs.addon }} \
            --image "${{ steps.check.outputs.image }}" \
            --docker-hub \
            --addon

  publish-release:
    needs: build
    runs-on: ubuntu-latest
    name: Publish Release
    timeout-minutes: 2
    permissions:
      contents: write
    steps:
      - name: Add build success status to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          release_tag="${{ inputs.tag }}"

          # Get current release body
          current_body=$(gh release view "${release_tag}" \
            --repo "${{ github.repository }}" \
            --json body --jq '.body')

          # Add build status
          cat > release_notes.md << EOF
          ${current_body}

          ---

          ## ðŸ—ï¸ Build Information

          âœ… **Build Status**: Success
          ðŸ“¦ **Architectures**: aarch64, amd64
          ðŸ”— **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          â±ï¸ **Built**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          Packages are available at: \`ghcr.io/${{ github.repository_owner }}/${{ inputs.addon }}\`
          EOF

          # Update release with build info
          gh release edit "${release_tag}" \
            --repo "${{ github.repository }}" \
            --notes-file release_notes.md

          echo "âœ… Added build status to release notes"

      - name: Publish draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          release_tag="${{ inputs.tag }}"
          echo "Publishing draft release ${release_tag}..."
          gh release edit "${release_tag}" \
            --repo "${{ github.repository }}" \
            --draft=false
          echo "âœ… Release ${release_tag} published successfully"

  cleanup-on-failure:
    needs: build
    if: failure()
    runs-on: ubuntu-latest
    name: Cleanup Failed Release
    timeout-minutes: 2
    permissions:
      contents: write
      issues: write
    steps:
      - name: Add failure status to release notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          release_tag="${{ inputs.tag }}"

          # Get current release body
          current_body=$(gh release view "${release_tag}" \
            --repo "${{ github.repository }}" \
            --json body --jq '.body' || echo "")

          # Add failure status
          cat > release_notes.md << EOF
          ${current_body}

          ---

          ## ðŸ—ï¸ Build Information

          âŒ **Build Status**: Failed
          ðŸ”— **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          â±ï¸ **Failed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          This release was not published due to build failures. Check the workflow run for details.
          The draft release and tag will be deleted to maintain a clean release history.
          EOF

          # Update release with failure info (for logging before deletion)
          gh release edit "${release_tag}" \
            --repo "${{ github.repository }}" \
            --notes-file release_notes.md || true

          echo "â„¹ï¸ Added failure status to release notes"

      - name: Create issue for failed build
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          addon="${{ inputs.addon }}"
          version="${{ inputs.version }}"
          tag="${{ inputs.tag }}"
          workflow_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Create issue to track the failure
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "ðŸš¨ Release build failed: ${addon} ${version}" \
            --label "build-failure,automation" \
            --body "## Build Failure Report

          **Add-on**: \`${addon}\`
          **Version**: \`${version}\`
          **Tag**: \`${tag}\`
          **Workflow Run**: ${workflow_url}
          **Failed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### What happened?

          The automated build for ${addon} ${version} failed during the release process. The draft release and tag have been deleted to maintain a clean release history.

          ### Next steps

          1. Review the [workflow run logs](${workflow_url}) to identify the root cause
          2. Fix the issue in a new PR
          3. Manually retry the build using the workflow_dispatch trigger:
             - Go to [Release Deploy workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/release-deploy.yaml)
             - Click 'Run workflow'
             - Enter: addon=\`${addon}\`, version=\`${version}\`, tag=\`${tag}\`

          ### Manual Retry

          If the issue is transient (e.g., network failure, rate limiting), you can retry without code changes:

          \`\`\`bash
          gh workflow run release-deploy.yaml \\
            --ref main \\
            -f addon='${addon}' \\
            -f version='${version}' \\
            -f tag='${tag}'
          \`\`\`
          " || echo "âš ï¸ Failed to create issue, continuing with cleanup"

      - name: Delete failed draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          release_tag="${{ inputs.tag }}"
          echo "âŒ Build failed - deleting draft release ${release_tag}"
          gh release delete "${release_tag}" \
            --repo "${{ github.repository }}" \
            --yes \
            --cleanup-tag
          echo "âœ… Draft release and tag deleted"

  trigger-metadata-update:
    needs: [build, publish-release]
    runs-on: ubuntu-latest
    name: Trigger Repository Metadata Update
    timeout-minutes: 2
    permissions:
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger addon-metadata workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Triggering addon-metadata.yaml workflow..."
          gh workflow run addon-metadata.yaml --ref main
          echo "Metadata update workflow triggered."
