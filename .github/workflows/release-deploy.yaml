---
name: Release Deploy

# Triggered by:
# 1. Workflow dispatch from release-please workflow (automatic)
# 2. Manual workflow_dispatch for retries
#
# Note: Does NOT use release events to avoid double-triggering when
# the draft is published after successful build

on:
  workflow_dispatch:
    inputs:
      addon:
        description: 'Add-on name (e.g., profilarr, romm)'
        required: true
        type: string
      version:
        description: 'Version (e.g., v1.2.3)'
        required: true
        type: string
      tag:
        description: 'Release tag (e.g., profilarr-v1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  extract-addon:
    runs-on: ubuntu-latest
    name: Extract Addon Info
    outputs:
      addon: ${{ steps.addon.outputs.name }}
      version: ${{ steps.addon.outputs.version }}
      tag: ${{ steps.addon.outputs.tag }}
    steps:
      - name: â¤µï¸ Check out repository
        uses: actions/checkout@v4

      - name: Extract addon from tag
        id: addon
        run: |
          # Get inputs from workflow_dispatch
          addon="${{ inputs.addon }}"
          version="${{ inputs.version }}"
          tag="${{ inputs.tag }}"

          echo "ðŸ“ Workflow dispatch: addon=${addon}, version=${version}, tag=${tag}"

          # Validate addon against release-please manifest
          valid_addons=$(jq -r 'keys[]' .release-please-manifest.json | tr '\n' ' ')
          if ! echo " $valid_addons " | grep -qF " ${addon} "; then
            echo "Error: Unknown addon '${addon}'. Valid addons: $valid_addons"
            exit 1
          fi

          echo "addon=${addon}" >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "âœ… Validated addon: ${addon}, version: ${version}"

  build:
    needs: extract-addon
    runs-on: ubuntu-latest
    name: "Build ${{ needs.extract-addon.outputs.addon }} (${{ matrix.arch }})"
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        arch: [aarch64, amd64]
    steps:
      - name: â¤µï¸ Check out repository
        uses: actions/checkout@v4
      - name: â„¹ï¸ Get addon info
        id: info
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ needs.extract-addon.outputs.addon }}"
      - name: ðŸ¦º Check if add-on should be built
        id: check
        run: |
          if [[ "${{ steps.info.outputs.architectures }}" =~ ${{ matrix.arch }} ]]; then
             echo "${{ matrix.arch }} is a supported arch for ${{ needs.extract-addon.outputs.addon }}, starting build"
             echo "build_arch=true" >> "$GITHUB_OUTPUT"
             echo "image=${{ steps.info.outputs.image }}" >> "$GITHUB_OUTPUT"
           else
             echo "${{ matrix.arch }} is not a valid arch for ${{ needs.extract-addon.outputs.addon }}, skipping build"
             echo "build_arch=false" >> "$GITHUB_OUTPUT"
          fi
      - name: ðŸ³ Login to GitHub Container Registry
        if: steps.check.outputs.build_arch == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: ðŸ—ï¸ Build ${{ needs.extract-addon.outputs.addon }} add-on
        if: steps.check.outputs.build_arch == 'true'
        uses: home-assistant/builder@2025.11.0
        with:
          args: |
            --${{ matrix.arch }} \
            --target /data/${{ needs.extract-addon.outputs.addon }} \
            --image "${{ steps.check.outputs.image }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon

  publish-release:
    # Only runs if BOTH extract-addon AND build jobs succeed
    # This ensures releases are only published when packages are built successfully
    needs: [extract-addon, build]
    runs-on: ubuntu-latest
    name: Publish Release
    timeout-minutes: 2
    permissions:
      contents: write
    steps:
      - name: Add build success status to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          release_tag="${{ needs.extract-addon.outputs.tag }}"

          # Get current release body
          current_body=$(gh release view "${release_tag}" \
            --repo "${{ github.repository }}" \
            --json body --jq '.body')

          # Add build status
          cat > release_notes.md << EOF
          ${current_body}

          ---

          ## ðŸ—ï¸ Build Information

          âœ… **Build Status**: Success
          ðŸ“¦ **Architectures**: aarch64, amd64
          ðŸ”— **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          â±ï¸ **Built**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          Packages are available at: \`ghcr.io/${{ github.repository_owner }}/${{ needs.extract-addon.outputs.addon }}\`
          EOF

          # Update release with build info
          gh release edit "${release_tag}" \
            --repo "${{ github.repository }}" \
            --notes-file release_notes.md

          echo "âœ… Added build status to release notes"

      - name: Publish draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          release_tag="${{ needs.extract-addon.outputs.tag }}"
          echo "Publishing draft release ${release_tag}..."
          gh release edit "${release_tag}" \
            --repo "${{ github.repository }}" \
            --draft=false
          echo "âœ… Release ${release_tag} published successfully"

  cleanup-on-failure:
    needs: [extract-addon, build]
    if: failure()
    runs-on: ubuntu-latest
    name: Cleanup Failed Release
    timeout-minutes: 2
    permissions:
      contents: write
      issues: write
    steps:
      - name: Add failure status to release notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          release_tag="${{ needs.extract-addon.outputs.tag }}"

          # Get current release body
          current_body=$(gh release view "${release_tag}" \
            --repo "${{ github.repository }}" \
            --json body --jq '.body' || echo "")

          # Add failure status
          cat > release_notes.md << EOF
          ${current_body}

          ---

          ## ðŸ—ï¸ Build Information

          âŒ **Build Status**: Failed
          ðŸ”— **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          â±ï¸ **Failed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          This release was not published due to build failures. Check the workflow run for details.
          The draft release and tag will be deleted to maintain a clean release history.
          EOF

          # Update release with failure info (for logging before deletion)
          gh release edit "${release_tag}" \
            --repo "${{ github.repository }}" \
            --notes-file release_notes.md || true

          echo "â„¹ï¸ Added failure status to release notes"

      - name: Create issue for failed build
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          addon="${{ needs.extract-addon.outputs.addon }}"
          version="${{ needs.extract-addon.outputs.version }}"
          tag="${{ needs.extract-addon.outputs.tag }}"
          workflow_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Create issue to track the failure
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "ðŸš¨ Release build failed: ${addon} ${version}" \
            --label "build-failure,automation" \
            --body "## Build Failure Report

          **Add-on**: \`${addon}\`
          **Version**: \`${version}\`
          **Tag**: \`${tag}\`
          **Workflow Run**: ${workflow_url}
          **Failed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### What happened?

          The automated build for ${addon} ${version} failed during the release process. The draft release and tag have been deleted to maintain a clean release history.

          ### Next steps

          1. Review the [workflow run logs](${workflow_url}) to identify the root cause
          2. Fix the issue in a new PR
          3. Manually retry the build using the workflow_dispatch trigger:
             - Go to [Release Deploy workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/release-deploy.yaml)
             - Click 'Run workflow'
             - Enter: addon=\`${addon}\`, version=\`${version}\`, tag=\`${tag}\`

          ### Manual Retry

          If the issue is transient (e.g., network failure, rate limiting), you can retry without code changes:

          \`\`\`bash
          gh workflow run release-deploy.yaml \\
            --ref main \\
            -f addon='${addon}' \\
            -f version='${version}' \\
            -f tag='${tag}'
          \`\`\`
          " || echo "âš ï¸ Failed to create issue, continuing with cleanup"

      - name: Delete failed draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          release_tag="${{ needs.extract-addon.outputs.tag }}"
          echo "âŒ Build failed - deleting draft release ${release_tag}"
          gh release delete "${release_tag}" \
            --repo "${{ github.repository }}" \
            --yes \
            --cleanup-tag
          echo "âœ… Draft release and tag deleted"

  trigger-metadata-update:
    needs: [extract-addon, build, publish-release]
    runs-on: ubuntu-latest
    name: Trigger Repository Metadata Update
    timeout-minutes: 2
    permissions:
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Trigger addon-metadata workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Triggering addon-metadata.yaml workflow..."
          gh workflow run addon-metadata.yaml --ref main
          echo "Metadata update workflow triggered."
