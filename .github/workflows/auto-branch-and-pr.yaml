---
name: Auto-Branch and PR

# yamllint disable-line rule:truthy
on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    name: ðŸ” Detect changed domains
    outputs:
      affected: ${{ steps.domains.outputs.affected }}
      filters: ${{ steps.filter.outputs.changes }}
    steps:
      - name: â¤µï¸ Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Install yq
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: ðŸ”§ Generate filters from domain-paths.yaml
        run: |
          # Transform domain-paths.yaml into filters format for dorny/paths-filter
          yq eval '.domains | with_entries(.value = .value.paths)' \
            .github/domain-paths.yaml > filters.yaml

          echo "Generated filters:"
          cat filters.yaml

      - name: ðŸŽ¯ Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: filters.yaml
          list-files: json

      - name: ðŸ“‹ Build affected domains list
        id: domains
        run: |
          # Build JSON array of affected domains
          AFFECTED=()

          # Read all domain names from config
          DOMAINS=$(yq eval '.domains | keys | .[]' .github/domain-paths.yaml)

          # Check which domains have changes
          for domain in $DOMAINS; do
            # Access the filter output for this domain
            FILTER_OUTPUT=$(echo '${{ toJSON(steps.filter.outputs) }}' | jq -r ".[\"$domain\"] // \"false\"")

            if [[ "$FILTER_OUTPUT" == "true" ]]; then
              echo "âœ… Domain affected: $domain"
              AFFECTED+=("\"$domain\"")
            else
              echo "â­ï¸ Domain unchanged: $domain"
            fi
          done

          # Create JSON array
          if [ ${#AFFECTED[@]} -eq 0 ]; then
            echo "affected=[]" >> "$GITHUB_OUTPUT"
            echo "No domains affected by this push"
          else
            AFFECTED_JSON="[$(IFS=,; echo "${AFFECTED[*]}")]"
            echo "affected=$AFFECTED_JSON" >> "$GITHUB_OUTPUT"
            echo "Affected domains: $AFFECTED_JSON"
          fi

      - name: ðŸ§¹ Clean up temporary files
        if: always()
        run: |
          rm -f filters.yaml

  route-to-branches:
    needs: detect-changes
    if: needs.detect-changes.outputs.affected != '[]'
    runs-on: ubuntu-latest
    name: ðŸš€ Route ${{ matrix.domain }} to branch
    strategy:
      fail-fast: false
      matrix:
        domain: ${{ fromJSON(needs.detect-changes.outputs.affected) }}
    steps:
      - name: â¤µï¸ Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Install yq
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: ðŸ” Get domain config
        id: config
        run: |
          BASE=$(yq eval ".domains.${{ matrix.domain }}.base_branch" .github/domain-paths.yaml)
          echo "base_branch=$BASE" >> "$GITHUB_OUTPUT"
          echo "Base branch for ${{ matrix.domain }}: $BASE"

      - name: ðŸ”§ Setup git configuration
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸŒ¿ Setup domain branch
        run: |
          BRANCH="app/${{ matrix.domain }}"
          echo "Domain branch: $BRANCH"

          # Fetch all branches
          git fetch origin

          # Check if domain branch exists remotely
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "Branch $BRANCH exists, checking it out"
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git merge origin/main --no-edit || {
              echo "âš ï¸ Merge conflict detected. Manual resolution required."
              exit 1
            }
          else
            echo "Branch $BRANCH does not exist, creating from main"
            git checkout -b "$BRANCH"
          fi

      - name: ðŸš€ Push domain branch
        run: |
          BRANCH="app/${{ matrix.domain }}"
          git push origin "$BRANCH"
          echo "âœ… Pushed $BRANCH to remote"

  create-pull-requests:
    needs: [detect-changes, route-to-branches]
    if: needs.detect-changes.outputs.affected != '[]'
    runs-on: ubuntu-latest
    name: ðŸ“¬ Create PR for ${{ matrix.domain }}
    strategy:
      fail-fast: false
      matrix:
        domain: ${{ fromJSON(needs.detect-changes.outputs.affected) }}
    steps:
      - name: â¤µï¸ Check out repository
        uses: actions/checkout@v4
        with:
          ref: app/${{ matrix.domain }}
          fetch-depth: 0

      - name: ðŸ“¦ Install yq
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: ðŸ” Get domain config
        id: config
        run: |
          BASE=$(yq eval ".domains.${{ matrix.domain }}.base_branch" .github/domain-paths.yaml)
          echo "base_branch=$BASE" >> "$GITHUB_OUTPUT"

      - name: ðŸ“ Get changed files list and detect labels
        id: changes
        run: |
          # Get list of changed files in this domain
          PATHS=$(yq eval ".domains.${{ matrix.domain }}.paths[]" .github/domain-paths.yaml)

          echo "## Changed Files" > /tmp/changes.md
          echo "" >> /tmp/changes.md

          # Detect change type from commit messages for labeling
          COMMITS=$(git log origin/${{ steps.config.outputs.base_branch }}..HEAD --pretty=format:"%s")
          LABELS="domain:${{ matrix.domain }},automated"

          # Add conventional commit labels based on commit messages
          if echo "$COMMITS" | grep -qiE "^(feat|feature)(\(.+\))?:"; then
            LABELS="$LABELS,feature"
          fi
          if echo "$COMMITS" | grep -qiE "^fix(\(.+\))?:"; then
            LABELS="$LABELS,fix"
          fi
          if echo "$COMMITS" | grep -qiE "^chore(\(.+\))?:"; then
            LABELS="$LABELS,chore"
          fi
          if echo "$COMMITS" | grep -qiE "^docs(\(.+\))?:"; then
            LABELS="$LABELS,documentation"
          fi
          if echo "$COMMITS" | grep -qiE "^(breaking|BREAKING CHANGE)"; then
            LABELS="$LABELS,breaking"
          fi

          echo "labels=$LABELS" >> "$GITHUB_OUTPUT"

          for path in $PATHS; do
            # Remove /** suffix for git diff
            clean_path="${path%/**}"
            if git diff --name-only origin/${{ steps.config.outputs.base_branch }}...HEAD | grep -q "^${clean_path}/"; then
              {
                echo "### \`$clean_path\`"
                git diff --name-only origin/${{ steps.config.outputs.base_branch }}...HEAD | grep "^${clean_path}/" | sed 's/^/- /'
                echo ""
              } >> /tmp/changes.md
            fi
          done

      - name: ðŸ“¬ Create or update pull request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: app/${{ matrix.domain }}
          base: ${{ steps.config.outputs.base_branch }}
          title: "[${{ matrix.domain }}] Automated domain updates"
          body: |
            ## ðŸ¤– Automated Changes for `${{ matrix.domain }}`

            This PR contains changes routed from the `main` branch for the `${{ matrix.domain }}` domain.

            ### ðŸ“‹ Configuration
            - **Domain**: `${{ matrix.domain }}`
            - **Base Branch**: `${{ steps.config.outputs.base_branch }}`
            - **Source**: Automated routing from `main`

            $(cat /tmp/changes.md)

            ---
            ðŸ”„ **Auto-generated by path-based routing workflow**
            ðŸ“… Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          labels: ${{ steps.changes.outputs.labels }}
          draft: false

      - name: ðŸ§¹ Clean up temporary files
        if: always()
        run: |
          rm -f /tmp/changes.md
