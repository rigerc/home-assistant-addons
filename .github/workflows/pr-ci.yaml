---
name: PR CI Validation

# yamllint disable-line rule:truthy
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: read
  packages: write

jobs:
  lint:
    name: üîç Lint
    uses: ./.github/workflows/lint.yaml

  build:
    name: üèóÔ∏è Build (validation mode)
    needs: lint
    uses: ./.github/workflows/builder.yaml
    with:
      validation_mode: true
      push_images: false
    secrets: inherit

  release-draft:
    name: üìù Create release draft
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: ‚§µÔ∏è Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: üîç Extract domain from branch
        id: domain
        env:
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          echo "Branch: $BRANCH_NAME"

          # Check if branch follows domain/* pattern
          if [[ "$BRANCH_NAME" =~ ^domain/(.+)$ ]]; then
            DOMAIN="${BASH_REMATCH[1]}"
            echo "domain=$DOMAIN" >> "$GITHUB_OUTPUT"
            echo "is_domain_branch=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Domain branch detected: $DOMAIN"
          else
            echo "is_domain_branch=false" >> "$GITHUB_OUTPUT"
            echo "‚è≠Ô∏è Not a domain branch, skipping release draft"
          fi

      - name: üìã Get addon version
        id: version
        if: steps.domain.outputs.is_domain_branch == 'true'
        run: |
          DOMAIN="${{ steps.domain.outputs.domain }}"

          # Check if domain directory has config.yaml
          if [[ -f "$DOMAIN/config.yaml" ]]; then
            VERSION=$(yq eval '.version' "$DOMAIN/config.yaml")
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "has_config=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Found version: $VERSION"
          else
            echo "has_config=false" >> "$GITHUB_OUTPUT"
            echo "‚ö†Ô∏è No config.yaml found in $DOMAIN"
          fi

      - name: üìù Draft release with Release Drafter
        if: steps.domain.outputs.is_domain_branch == 'true' && steps.version.outputs.has_config == 'true'
        uses: release-drafter/release-drafter@v6
        with:
          config-name: release-drafter.yml
          name: '${{ steps.domain.outputs.domain }} v${{ steps.version.outputs.version }}'
          tag: '${{ steps.domain.outputs.domain }}-v${{ steps.version.outputs.version }}'
          version: '${{ steps.version.outputs.version }}'
          publish: false
          prerelease: false
          commitish: ${{ github.head_ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
