# ==============================================================================
# Ingress server configuration
# Listens on ingress_port and proxies to backend application
# Variables (%%port%%, %%interface%%) are replaced by cont-init.d script
# ==============================================================================

server {
    listen %%interface%%:%%port%% default_server;
    include /etc/nginx/includes/server_params.conf;
    include /etc/nginx/includes/proxy_params.conf;

    # Allow large file uploads (adjust as needed)
    client_max_body_size 0;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer" always;

    # Root location - redirect to app UI
    location = / {
        # Avoid adding port to redirects
        absolute_redirect off;
        return 301 /ui/;
    }

    # Main application proxy
    location / {
        # Proxy to backend application
        proxy_pass http://127.0.0.1:8080;

        # Disable buffering for real-time updates
        proxy_buffering off;

        # Pass request headers
        proxy_pass_request_headers on;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Timeouts for long-running requests
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # Health check endpoint (optional)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Static files (if your app serves them)
    location /static/ {
        proxy_pass http://127.0.0.1:8080/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
