#!/usr/bin/with-contenv bashio

# Change to backend directory
cd /backend || bashio::exit.nok "Failed to change to /backend directory"

# Get ingress port
ROMM_PORT=$(bashio::addon.ingress_port)
if [ -z "$ROMM_PORT" ]; then
    ROMM_PORT=8095
fi

# Export database configuration
export DB_HOST="$(bashio::config 'database.host')"
export DB_PORT="$(bashio::config 'database.port')"
export DB_NAME="$(bashio::config 'database.name')"
export DB_USER="$(bashio::config 'database.user')"
export DB_PASSWD="$(bashio::config 'database.password')"

# Export auth configuration
export ROMM_AUTH_SECRET_KEY="$(bashio::config 'auth_secret_key')"

# Export metadata provider credentials (optional)
if bashio::config.has_value 'metadata_providers.screenscraper_user'; then
    export SCREENSCRAPER_USER="$(bashio::config 'metadata_providers.screenscraper_user')"
fi
if bashio::config.has_value 'metadata_providers.screenscraper_password'; then
    export SCREENSCRAPER_PASSWORD="$(bashio::config 'metadata_providers.screenscraper_password')"
fi
if bashio::config.has_value 'metadata_providers.retroachievements_api_key'; then
    export RETROACHIEVEMENTS_API_KEY="$(bashio::config 'metadata_providers.retroachievements_api_key')"
fi
if bashio::config.has_value 'metadata_providers.steamgriddb_api_key'; then
    export STEAMGRIDDB_API_KEY="$(bashio::config 'metadata_providers.steamgriddb_api_key')"
fi
if bashio::config.has_value 'metadata_providers.igdb_client_id'; then
    export IGDB_CLIENT_ID="$(bashio::config 'metadata_providers.igdb_client_id')"
fi
if bashio::config.has_value 'metadata_providers.igdb_client_secret'; then
    export IGDB_CLIENT_SECRET="$(bashio::config 'metadata_providers.igdb_client_secret')"
fi
if bashio::config.has_value 'metadata_providers.mobygames_api_key'; then
    export MOBYGAMES_API_KEY="$(bashio::config 'metadata_providers.mobygames_api_key')"
fi

# Export provider flags
export HASHEOUS_API_ENABLED="$(bashio::config 'metadata_providers.hasheous_enabled')"
export PLAYMATCH_API_ENABLED="$(bashio::config 'metadata_providers.playmatch_enabled')"
export LAUNCHBOX_API_ENABLED="$(bashio::config 'metadata_providers.launchbox_enabled')"

# Export volume paths
export ROMM_RESOURCES_PATH="/data/romm_resources"
export REDIS_DATA_PATH="/data/redis_data"
export ROMM_LIBRARY_PATH="$(bashio::config 'library_path')"
export ROMM_ASSETS_PATH="/data/romm_assets"

# Optional: config.yml path
if [ -f "/config/romm/config.yml" ]; then
    export ROMM_CONFIG_PATH="/config/romm/config.yml"
fi

# Set Python environment
export PYTHONUNBUFFERED=1
export PYTHONDONTWRITEBYTECODE=1
export PYTHONPATH=/backend

# Disable OpenTelemetry (not needed for HA add-on)
export OTEL_SDK_DISABLED=true

bashio::log.info "Starting Romm services..."
bashio::log.info "Port: ${ROMM_PORT}"
bashio::log.info "Database: ${DB_HOST}:${DB_PORT}/${DB_NAME}"
bashio::log.info "Library: ${ROMM_LIBRARY_PATH}"

# Start valkey-server in background (internal Redis for background jobs)
bashio::log.info "Starting internal valkey..."
valkey-server --dir /data/redis_data --daemonize yes --loglevel warning

# Wait for valkey to be ready
sleep 2

# Run database migrations
bashio::log.info "Running database migrations..."
if ! alembic upgrade head; then
    bashio::exit.nok "Database migrations failed"
fi

# Start RQ worker in background (handles background tasks)
bashio::log.info "Starting RQ worker..."
RQ_REDIS_HOST=127.0.0.1 \
    RQ_REDIS_PORT=6379 \
    RQ_REDIS_DB=0 \
    PYTHONPATH="/backend:${PYTHONPATH-}" rq worker \
    --path /backend \
    --url "redis://127.0.0.1:6379/0" \
    --results-ttl 86400 \
    high default low &

# Start gunicorn (main web application)
bashio::log.info "Starting Romm web server..."
exec gunicorn main:app \
    --bind "0.0.0.0:${ROMM_PORT}" \
    --worker-class uvicorn_worker.UvicornWorker \
    --workers 1 \
    --timeout 300 \
    --keep-alive 2 \
    --max-requests 1000 \
    --max-requests-jitter 100 \
    --worker-connections 1000 \
    --error-logfile -
