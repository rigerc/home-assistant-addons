# Home Assistant Add-ons Repository Workflow Guide

## Repository Structure

```
ha-addons-3/
├── manifest.json              # [AUTO-GENERATED] Central addon registry
├── README.md                  # [AUTO-GENERATED] Repository homepage
├── .github/
│   ├── workflows/
│   │   ├── addon-metadata.yml     # Generates manifest & READMEs
│   │   ├── pr-metadata.yml        # Fetches Dependabot PR metadata
│   │   └── dependabot-actions-validation.yml  # Validates GitHub Actions updates
│   ├── actions/
│   │   └── update-readme/         # Custom action for README generation
│   └── dependabot.yml             # Dependabot configuration
├── scripts/
│   └── manifest.sh                # Manifest generation script
├── romm/
│   ├── config.yaml                # [MANUAL] Addon metadata
│   ├── Dockerfile                 # [MANUAL] Multi-stage Docker build
│   ├── build.yaml                 # [MANUAL] Project URL
│   └── README.md                  # [AUTO-GENERATED] Addon documentation
├── profilarr/
├── profilarr-v1/
└── cleanuparr/
    └── (same structure as romm)
```

## Auto-Generated Files

### `/manifest.json`
**Generated by:** `scripts/manifest.sh` via `addon-metadata.yml` workflow
**Source:** Scans all addon directories for `config.yaml`, `Dockerfile`, and `build.yaml`
**Fields:**
- `slug` - From `config.yaml`
- `version` - From `config.yaml`
- `name` - From `config.yaml`
- `description` - From `config.yaml`
- `arch` - From `config.yaml`
- `image` - **Auto-extracted** from Dockerfile `FROM ... AS` line (image name before `:`)
- `tag` - **Auto-extracted** from Dockerfile `FROM ... AS` line (version after `:`)
- `project` - From `build.yaml` (optional)

**Example:**
```json
{
  "slug": "romm",
  "version": "0.1.26",
  "name": "Romm",
  "description": "Self-hosted ROM collection manager...",
  "arch": ["aarch64", "amd64"],
  "image": "rommapp/romm",
  "tag": "4.6.0",
  "project": "https://github.com/rommapp/romm"
}
```

### `/README.md` and `/{addon}/README.md`
**Generated by:** `.github/actions/update-readme` via `addon-metadata.yml` workflow
**Template:** `.README.tmpl` (root) and `.README_ADDON.tmpl` (addon-specific)
**Data source:** `manifest.json`

## GitHub Actions Automation

### Addon Metadata Workflow (`addon-metadata.yml`)

**Triggers:**
- Push to `main` (changes to `**/config.yaml`, `**/Dockerfile`, `**/build.yaml`)
- Pull requests (same file paths)
- Manual dispatch

**What it does:**
1. Scans all addon directories
2. Extracts metadata from `config.yaml`, `Dockerfile`, `build.yaml`
3. Generates `manifest.json`
4. Updates dependabot.yml directories (if using `-d` flag)
5. Generates all README files using gomplate templates
6. Commits changes with `[skip ci]` tag

**Important:** Skips PRs with the `ci` label to prevent loops

### Dependabot PR Metadata (`pr-metadata.yml`)

**Triggers:** All pull requests from `dependabot[bot]`

**What it does:**
- Fetches Dependabot metadata
- Adds alert and compatibility information
- No file modifications

### Dependabot Actions Validation (`dependabot-actions-validation.yml`)

**Triggers:** Pull requests from `dependabot[bot]`

**What it does:**
1. Checks if PR is a GitHub Actions update
2. Runs `actionlint` to validate workflow syntax
3. Fails PR if syntax errors exist

## Dependabot Configuration

Located at `.github/dependabot.yml`

**Monitored ecosystems:**
- **Docker:** Tracks base images in addon Dockerfiles (`FROM <image>:<tag>` lines)
  - Creates PRs to update image tags when new versions are released
  - When merged, triggers `addon-metadata.yml` to update `manifest.json` automatically
- **GitHub Actions:** Tracks action versions in workflows

**Configuration:**
- Schedule: Weekly on Monday at 05:00 UTC
- PR limits: Max 5 open PRs per ecosystem
- Grouping: Minor/patch updates grouped together, major updates separate
- Labels: Auto-applied for filtering (`dependencies`, `docker`, `addons`, `ci`, `github-actions`)
- Commit prefixes: `docker:` for Docker updates, `ci:` for GitHub Actions updates

**Typical Dependabot workflow:**
1. Dependabot detects new upstream image version (e.g., `rommapp/romm:4.7.0` → `4.8.0`)
2. Opens PR updating Dockerfile `FROM` line
3. Review and merge PR
4. `addon-metadata.yml` workflow runs automatically
5. `manifest.json` updated with new `tag` field
6. Ready to release using deployer workflow

## Release & Deployment Workflows

### Release Drafter (`release-drafter.yaml`)

**Triggers:**
- Push to main branch
- Pull requests to main
- After addon-metadata workflow completes

**What it does:**
1. Detects which addons have changed files
2. Creates/updates draft releases for each changed addon
3. Generates release notes using `.github/release-drafter-{addon}.yml` config
4. Does NOT publish releases or modify files

### Deployer (`deployer.yaml`)

**Triggers:**
- Manual dispatch (dropdown menu to select addon)
- Workflow call from other workflows

**What it does - AUTOMATED VERSIONING:**
1. Runs release drafter to get tag name and release notes
2. **AUTO-UPDATES `config.yaml` version field** from release tag
3. **AUTO-UPDATES `build.yaml`** with Docker OCI labels (title, URL, source, version, date, revision)
4. **AUTO-UPDATES `CHANGELOG.md`** with release notes
5. Builds multi-architecture Docker images (amd64, aarch64)
6. Pushes images to GitHub Container Registry
7. Updates README.md files
8. Commits all changes with `[skip ci]`
9. Publishes the GitHub release

**Important:** The deployer workflow automatically manages addon versioning - you don't manually update `config.yaml` version when releasing.

### Workflow Dispatch Addon List

The deployer workflow dropdown is **AUTO-UPDATED** by `scripts/manifest.sh -w`:
- Scans all addon directories
- Updates `deployer.yaml` inputs options with addon slugs
- Runs automatically via `addon-metadata.yml` workflow

## Developer Workflow

### Updating Upstream Image Version

**Option 1: Dependabot (Automatic)**
- Dependabot monitors Dockerfile `FROM` lines
- Creates PRs to update `FROM <image>:<tag>` when new versions are available
- When merged, triggers `addon-metadata.yml` to update `manifest.json`

**Option 2: Manual Update**
1. **Update Dockerfile (MANUAL)**
   ```dockerfile
   FROM rommapp/romm:4.7.0 AS builder
   ```

2. **Push changes**
   - GitHub Actions auto-updates `manifest.json`
   - Both `image` and `tag` fields auto-extracted from Dockerfile

### Releasing an Addon

1. **Merge changes to main branch**
   - Code changes, dependency updates, etc.
   - Release drafter creates/updates draft release

2. **Trigger deployer workflow (MANUAL)**
   - Go to Actions → Deployer → Run workflow
   - Select addon from dropdown
   - Workflow auto-updates version, builds, and publishes

3. **Version field in `config.yaml` updates automatically**
   - No manual version bumping needed

### Adding a New Addon

**Manual files to create:**

1. **`config.yaml`** - Home Assistant addon configuration
   - `slug`, `version`, `name`, `description`, `arch` (all required initially)
   - `version` will be auto-updated by deployer workflow on releases

2. **`Dockerfile`** - Container build instructions
   - Must have `FROM <image>:<tag> AS <stage>` format
   - Dependabot will create PRs to update the tag automatically

3. **`build.yaml`** - Build metadata (optional)
   - `project` - Upstream GitHub URL
   - Docker labels auto-updated by deployer workflow on releases

**Auto-updated files (no manual edits needed):**

- **`manifest.json`** - Central registry
  - `image` and `tag` fields extracted from Dockerfile `FROM` line

- **`README.md`** - Generated from `.README_ADDON.tmpl` template
  - Updated by addon-metadata workflow

- **`CHANGELOG.md`** - Release history
  - Updated by deployer workflow on releases

## Key Constraints

1. **Dockerfile requirement:** Addons without a Dockerfile are ignored (e.g., `huntarr/` exists but has no Dockerfile)

2. **FROM line format:** Dockerfile must have `FROM <image>:<tag> AS <stage>` for auto-extraction to work

3. **CI label skip:** PRs labeled with `ci` skip the metadata workflow to prevent infinite loops

4. **[skip ci] commits:** Auto-generated commits include `[skip ci]` to prevent triggering workflows

5. **Same-repo PRs only:** Metadata workflow only runs on PRs from the same repository, not forks